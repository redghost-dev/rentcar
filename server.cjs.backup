const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const bodyParser = require('body-parser');
const cors = require('cors');
const path = require('path');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const rateLimit = require('express-rate-limit');
const { body, validationResult } = require('express-validator');
const helmet = require('helmet');
const fs = require('fs');
const https = require('https');

const app = express();
const PORT = 3000;

// ===== G√úVENLƒ∞K AYARLARI =====

// JWT Secret Key (Production'da environment variable kullan!)
const JWT_SECRET = process.env.JWT_SECRET || 'rancar-super-secret-key-2025-change-this-in-production';
const JWT_EXPIRES_IN = '24h';

// Helmet - HTTP header g√ºvenliƒüi
app.use(helmet({
    contentSecurityPolicy: false, // CSP'yi devre dƒ±≈üƒ± bƒ±rak (CDN'ler i√ßin)
}));

// CORS Konfig√ºrasyonu - Sadece kendi domain'e izin ver
const allowedOrigins = [
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'http://localhost:5173', // Vite dev server
    'http://127.0.0.1:5173',
    // Production domain'inizi buraya ekleyin: 'https://yourdomain.com'
];

const corsOptions = {
    origin: function (origin, callback) {
        // ngrok veya development i√ßin origin undefined olabilir
        if (!origin || allowedOrigins.indexOf(origin) !== -1 || origin.includes('ngrok')) {
            callback(null, true);
        } else {
            callback(new Error('CORS politikasƒ± tarafƒ±ndan engellendi'));
        }
    },
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    credentials: true
};

// Rate Limiting - DDoS korumasƒ±
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 dakika
    max: 1000, // IP ba≈üƒ±na 1000 istek (development i√ßin y√ºksek)
    message: '√áok fazla istek g√∂nderdiniz. L√ºtfen 15 dakika sonra tekrar deneyin.'
});

const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 dakika
    max: 50, // IP ba≈üƒ±na 50 login denemesi (development i√ßin y√ºksek)
    message: '√áok fazla giri≈ü denemesi. L√ºtfen 15 dakika sonra tekrar deneyin.',
    skipSuccessfulRequests: true // Ba≈üarƒ±lƒ± giri≈ü sayƒ±lmaz
});

// Middleware
app.use(cors(corsOptions));
app.use(limiter); // T√ºm route'lara rate limit uygula
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'dist')));
// Admin panel i√ßin src klas√∂r√ºn√º de servis et
app.use('/src', express.static(path.join(__dirname, 'src')));
// img klas√∂r√ºn√º serve et
app.use('/img', express.static(path.join(__dirname, 'img')));

// SQLite Database
const db = new sqlite3.Database('./data.db', (err) => {
    if (err) console.error(err);
    else console.log('‚úì SQLite baƒülantƒ±sƒ± ba≈üarƒ±lƒ±');
});

// Tablolarƒ± olu≈ütur
db.serialize(() => {
    // Admin Users tablosu
    db.run(`CREATE TABLE IF NOT EXISTS admin_users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL,
        email TEXT,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        lastLogin DATETIME
    )`);

    // Vehicles tablosu
    db.run(`CREATE TABLE IF NOT EXISTS vehicles (
        id TEXT PRIMARY KEY,
        model TEXT NOT NULL,
        price TEXT NOT NULL,
        deposit TEXT NOT NULL,
        status TEXT NOT NULL,
        image TEXT NOT NULL
    )`);

    // Quotations (Teklifler) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS quotations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT NOT NULL,
        phone TEXT NOT NULL,
        vehicleId TEXT NOT NULL,
        message TEXT NOT NULL,
        status TEXT DEFAULT 'yeni',
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(vehicleId) REFERENCES vehicles(id)
    )`);

    // Reservations (Ara√ß Rezervasyonlarƒ±) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS reservations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        fullName TEXT NOT NULL,
        email TEXT NOT NULL,
        phone TEXT NOT NULL,
        pickupLocation TEXT NOT NULL,
        dropoffLocation TEXT NOT NULL,
        pickupDate TEXT NOT NULL,
        pickupTime TEXT NOT NULL,
        dropoffDate TEXT NOT NULL,
        dropoffTime TEXT NOT NULL,
        vehicleId TEXT,
        differentDropoff INTEGER DEFAULT 0,
        specialRequests TEXT,
        status TEXT DEFAULT 'yeni',
        totalPrice TEXT,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(vehicleId) REFERENCES vehicles(id)
    )`);

    // Locations (Alƒ±≈ü/ƒ∞ade Yerleri) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS locations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        region TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        code TEXT NOT NULL,
        type TEXT NOT NULL DEFAULT 'airport',
        isActive INTEGER DEFAULT 1,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);
});

// Default admin kullanƒ±cƒ±sƒ± olu≈ütur
setTimeout(() => {
    db.get("SELECT COUNT(*) as count FROM admin_users", async (err, row) => {
        if (err) {
            console.error('‚ùå Admin user check hatasƒ±:', err);
            return;
        }
        
        if (row && row.count === 0) {
            console.log('üë§ Default admin kullanƒ±cƒ±sƒ± olu≈üturuluyor...');
            const hashedPassword = await bcrypt.hash('admin123', 10);
            
            db.run(
                "INSERT INTO admin_users (username, password, email) VALUES (?, ?, ?)",
                ['admin', hashedPassword, 'admin@rancar.com'],
                (err) => {
                    if (err) {
                        console.error('‚ùå Admin user INSERT hatasƒ±:', err);
                    } else {
                        console.log('‚úÖ Admin kullanƒ±cƒ±sƒ± olu≈üturuldu (username: admin, password: admin123)');
                    }
                }
            );
        }
    });
}, 200);

// Default ara√ßlarƒ± ekle
setTimeout(() => {
    db.get("SELECT COUNT(*) as count FROM vehicles", (err, row) => {
        if (err) {
            console.error('‚ùå SELECT COUNT hatasƒ±:', err);
            return;
        }
        console.log('üìä Ara√ß sayƒ±sƒ±:', row?.count);
        if (row && row.count === 0) {
            console.log('üöó Default ara√ßlar ekleniyor...');
            const defaultVehicles = [
                { id: '1', model: 'Toyota Corolla', price: '‚Ç∫450', deposit: '‚Ç∫5.000', status: 'M√ºsait', image: '/img/1.jpg' },
                { id: '2', model: 'Honda Civic', price: '‚Ç∫500', deposit: '‚Ç∫5.500', status: 'M√ºsait', image: '/img/2.jpg' },
                { id: '3', model: 'Ford Focus', price: '‚Ç∫480', deposit: '‚Ç∫5.200', status: 'M√ºsait', image: '/img/3.jpg' },
                { id: '4', model: 'Hyundai Elantra', price: '‚Ç∫420', deposit: '‚Ç∫4.800', status: 'M√ºsait', image: '/img/4.jpg' },
                { id: '5', model: 'Nissan Altima', price: '‚Ç∫520', deposit: '‚Ç∫5.800', status: 'M√ºsait', image: '/img/5.jpeg' }
            ];

            let inserted = 0;
            defaultVehicles.forEach(v => {
                db.run(
                    "INSERT INTO vehicles (id, model, price, deposit, status, image) VALUES (?, ?, ?, ?, ?, ?)",
                    [v.id, v.model, v.price, v.deposit, v.status, v.image],
                    (err) => {
                        if (err) console.error('‚ùå INSERT hatasƒ±:', err);
                        else inserted++;
                        if (inserted === defaultVehicles.length) {
                            console.log('‚úì T√ºm default ara√ßlar eklendi');
                        }
                    }
                );
            });
        }
    });

    // Default lokasyonlarƒ± ekle
    db.get("SELECT COUNT(*) as count FROM locations", (err, row) => {
        if (err) {
            console.error('‚ùå SELECT COUNT locations hatasƒ±:', err);
            return;
        }
        if (row && row.count === 0) {
            console.log('üìç Default lokasyonlar ekleniyor...');
            const defaultLocations = [
                { region: 'ƒ∞stanbul Avrupa', name: 'ƒ∞stanbul Havalimanƒ± (IST)', code: 'IST', type: 'airport' },
                { region: 'ƒ∞stanbul Anadolu', name: 'Sabiha G√∂k√ßen ƒ∞√ß Hatlar (SAW)', code: 'SAW', type: 'airport' },
                { region: 'ƒ∞stanbul Anadolu', name: 'Sabiha G√∂k√ßen Dƒ±≈ü Hatlar (SAW)', code: 'SAW', type: 'airport' },
                { region: 'ƒ∞zmir', name: 'Adnan Menderes H. Dƒ±≈ü Hatlar (ADB)', code: 'ADB', type: 'airport' },
                { region: 'ƒ∞zmir', name: 'Adnan Menderes H. ƒ∞√ß Hatlar (ADB)', code: 'ADB', type: 'airport' },
                { region: 'Antalya', name: 'Antalya Havalimanƒ± Dƒ±≈ü Hatlar (AYT)', code: 'AYT', type: 'airport' },
                { region: 'Antalya', name: 'Antalya Havalimanƒ± ƒ∞√ß Hatlar (AYT)', code: 'AYT', type: 'airport' },
                { region: 'Ankara', name: 'Esenboƒüa Havalimanƒ± Dƒ±≈ü Hatlar (ESB)', code: 'ESB', type: 'airport' },
                { region: 'Ankara', name: 'Esenboƒüa Havalimanƒ± ƒ∞√ß Hatlar (ESB)', code: 'ESB', type: 'airport' },
                { region: 'Kayseri', name: 'Kayseri Havalimanƒ± (ASR)', code: 'ASR', type: 'airport' },
                { region: 'Adana-Mersin', name: '√áukurova Havalimanƒ± (COV)', code: 'COV', type: 'airport' },
                { region: 'Gaziantep', name: 'Gaziantep Havalimanƒ± Dƒ±≈ü Hatlar (GZT)', code: 'GZT', type: 'airport' },
                { region: 'Gaziantep', name: 'Gaziantep Havalimanƒ± ƒ∞√ß Hatlar (GZT)', code: 'GZT', type: 'airport' },
                { region: 'Diyarbakƒ±r', name: 'Diyarbakƒ±r Havalimanƒ± (DIY)', code: 'DIY', type: 'airport' },
                { region: 'Diyarbakƒ±r', name: 'Diyarbakƒ±r Rancar Ofis (DIY)', code: 'DIY', type: 'office' },
                { region: 'Konya', name: 'Konya Havalimanƒ± Dƒ±≈ü Hatlar (KYA)', code: 'KYA', type: 'airport' },
                { region: 'Konya', name: 'Konya Havalimanƒ± ƒ∞√ß Hatlar (KYA)', code: 'KYA', type: 'airport' },
                { region: 'Trabzon', name: 'Trabzon Havalimanƒ± Dƒ±≈ü Hatlar (TZX)', code: 'TZX', type: 'airport' },
                { region: 'Trabzon', name: 'Trabzon Havalimanƒ± ƒ∞√ß Hatlar (TZX)', code: 'TZX', type: 'airport' },
                { region: 'Samsun', name: 'Samsun Havalimanƒ± (SZF)', code: 'SZF', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Havalimanƒ± ƒ∞√ß Hatlar (HTY)', code: 'HTY', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Havalimanƒ± Dƒ±≈ü Hatlar (HTY)', code: 'HTY', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Rancar Ofis (HTY)', code: 'HTY', type: 'office' },
                { region: 'Dalaman', name: 'Dalaman Havalimanƒ± Dƒ±≈ü Hatlar (DLM)', code: 'DLM', type: 'airport' },
                { region: 'Dalaman', name: 'Dalaman Havalimanƒ± ƒ∞√ß Hatlar (DLM)', code: 'DLM', type: 'airport' },
                { region: 'Bodrum', name: 'Bodrum Havalimanƒ± Dƒ±≈ü Hatlar (BJV)', code: 'BJV', type: 'airport' },
                { region: 'Bodrum', name: 'Bodrum Havalimanƒ± ƒ∞√ß Hatlar (BJV)', code: 'BJV', type: 'airport' }
            ];

            let inserted = 0;
            defaultLocations.forEach(loc => {
                db.run(
                    "INSERT OR IGNORE INTO locations (region, name, code, type) VALUES (?, ?, ?, ?)",
                    [loc.region, loc.name, loc.code, loc.type],
                    (err) => {
                        if (err) console.error('‚ùå Location INSERT hatasƒ±:', err);
                        else inserted++;
                        if (inserted === defaultLocations.length) {
                            console.log(`‚úì ${defaultLocations.length} lokasyon eklendi`);
                        }
                    }
                );
            });
        }
    });
}, 300);

// ===== JWT MIDDLEWARE =====

// JWT Token doƒürulama middleware
function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

    if (!token) {
        return res.status(401).json({ error: 'Token bulunamadƒ±. Giri≈ü yapmanƒ±z gerekiyor.' });
    }

    jwt.verify(token, JWT_SECRET, (err, user) => {
        if (err) {
            console.error('‚ùå Token doƒürulama hatasƒ±:', err.message);
            return res.status(403).json({ error: 'Ge√ßersiz veya s√ºresi dolmu≈ü token.' });
        }
        req.user = user;
        next();
    });
}

// ===== AUTHENTICATION API =====

// POST Admin Login
app.post('/api/auth/login', loginLimiter, [
    body('username').trim().isLength({ min: 3 }).escape(),
    body('password').isLength({ min: 6 })
], async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { username, password } = req.body;

    try {
        db.get("SELECT * FROM admin_users WHERE username = ?", [username], async (err, user) => {
            if (err) {
                console.error('‚ùå Login DB hatasƒ±:', err);
                return res.status(500).json({ error: 'Sunucu hatasƒ±' });
            }

            if (!user) {
                return res.status(401).json({ error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' });
            }

            const validPassword = await bcrypt.compare(password, user.password);
            if (!validPassword) {
                return res.status(401).json({ error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' });
            }

            // JWT Token olu≈ütur
            const token = jwt.sign(
                { id: user.id, username: user.username },
                JWT_SECRET,
                { expiresIn: JWT_EXPIRES_IN }
            );

            // Son giri≈ü zamanƒ±nƒ± g√ºncelle
            db.run("UPDATE admin_users SET lastLogin = CURRENT_TIMESTAMP WHERE id = ?", [user.id]);

            console.log(`‚úÖ Admin giri≈üi: ${username}`);
            res.json({
                success: true,
                token,
                user: {
                    id: user.id,
                    username: user.username,
                    email: user.email
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Login hatasƒ±:', error);
        res.status(500).json({ error: 'Sunucu hatasƒ±' });
    }
});

// POST Token doƒürulama
app.post('/api/auth/verify', authenticateToken, (req, res) => {
    res.json({ success: true, user: req.user });
});

// POST ≈ûifre deƒüi≈ütirme
app.post('/api/auth/change-password', authenticateToken, [
    body('oldPassword').isLength({ min: 6 }),
    body('newPassword').isLength({ min: 6 })
], async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { oldPassword, newPassword } = req.body;

    try {
        db.get("SELECT * FROM admin_users WHERE id = ?", [req.user.id], async (err, user) => {
            if (err || !user) {
                return res.status(500).json({ error: 'Kullanƒ±cƒ± bulunamadƒ±' });
            }

            const validPassword = await bcrypt.compare(oldPassword, user.password);
            if (!validPassword) {
                return res.status(401).json({ error: 'Mevcut ≈üifre hatalƒ±' });
            }

            const hashedPassword = await bcrypt.hash(newPassword, 10);
            db.run("UPDATE admin_users SET password = ? WHERE id = ?", [hashedPassword, user.id], (err) => {
                if (err) {
                    return res.status(500).json({ error: '≈ûifre g√ºncellenemedi' });
                }
                console.log(`‚úÖ ≈ûifre deƒüi≈ütirildi: ${user.username}`);
                res.json({ success: true, message: '≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi' });
            });
        });
    } catch (error) {
        console.error('‚ùå ≈ûifre deƒüi≈ütirme hatasƒ±:', error);
        res.status(500).json({ error: 'Sunucu hatasƒ±' });
    }
});

// ===== VEHICLES API =====

// GET t√ºm ara√ßlar
app.get('/api/vehicles', (req, res) => {
    console.log('üì° GET /api/vehicles isteƒüi alƒ±ndƒ±');
    db.all("SELECT * FROM vehicles", (err, rows) => {
        if (err) {
            console.error('‚ùå DB Hatasƒ±:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úì ${rows?.length || 0} ara√ß d√∂nd√ºr√ºl√ºyor`);
        if (rows && rows.length > 0) {
            console.log('üîç ƒ∞lk ara√ß ID:', rows[0].id, 'Type:', typeof rows[0].id);
        }
        res.json(rows || []);
    });
});

// GET bir ara√ß (ID'ye g√∂re)
app.get('/api/vehicles/:id', (req, res) => {
    db.get("SELECT * FROM vehicles WHERE id = ?", [req.params.id], (err, row) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        if (!row) {
            return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
        }
        res.json(row);
    });
});

// POST yeni ara√ß ekle (KORUNMALI)
app.post('/api/vehicles', authenticateToken, [
    body('model').trim().notEmpty().escape(),
    body('price').trim().notEmpty(),
    body('deposit').trim().notEmpty()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id, model, price, deposit, status, image } = req.body;

    if (!id || !model || !price || !deposit) {
        return res.status(400).json({ error: 'Gerekli alanlar eksik' });
    }

    db.run(
        "INSERT INTO vehicles (id, model, price, deposit, status, image) VALUES (?, ?, ?, ?, ?, ?)",
        [id, model, price, deposit, status || 'M√ºsait', image || '/img/default.png'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id, model, price, deposit, status: status || 'M√ºsait', image });
        }
    );
});

// PUT ara√ß g√ºncelle (KORUNMALI)
app.put('/api/vehicles/:id', authenticateToken, [
    body('model').trim().notEmpty().escape(),
    body('price').trim().notEmpty(),
    body('deposit').trim().notEmpty()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { model, price, deposit, status, image } = req.body;

    console.log('üîÑ UPDATE isteƒüi - ID:', req.params.id, 'Type:', typeof req.params.id);
    console.log('üìù Yeni veriler:', { model, price, deposit, status, image });

    db.run(
        "UPDATE vehicles SET model = ?, price = ?, deposit = ?, status = ?, image = ? WHERE id = ?",
        [model, price, deposit, status, image, req.params.id],
        function(err) {
            if (err) {
                console.error('‚ùå UPDATE hatasƒ±:', err);
                return res.status(500).json({ error: err.message });
            }
            console.log('‚úÖ UPDATE sonucu - Deƒüi≈ütirilen satƒ±r sayƒ±sƒ±:', this.changes);
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
            }
            res.json({ id: req.params.id, model, price, deposit, status, image });
        }
    );
});

// DELETE ara√ß sil (KORUNMALI)
app.delete('/api/vehicles/:id', authenticateToken, (req, res) => {
    console.log('üóëÔ∏è DELETE isteƒüi - ID:', req.params.id, 'Type:', typeof req.params.id);
    
    db.run("DELETE FROM vehicles WHERE id = ?", [req.params.id], function(err) {
        if (err) {
            console.error('‚ùå DELETE hatasƒ±:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ DELETE sonucu - Silinen satƒ±r sayƒ±sƒ±:', this.changes);
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
        }
        res.json({ message: 'Ara√ß silindi' });
    });
});

// ==========================================
// QUOTATIONS (TKLƒ∞FLER) API ENDPOINTS
// ==========================================

// GET t√ºm teklifleri al
app.get('/api/quotations', (req, res) => {
    db.all(`
        SELECT q.*, v.model as vehicleName 
        FROM quotations q 
        LEFT JOIN vehicles v ON q.vehicleId = v.id 
        ORDER BY q.createdAt DESC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// POST yeni teklif ekle
app.post('/api/quotations', (req, res) => {
    const { name, email, phone, vehicleId, message, status } = req.body;

    // Validasyon
    if (!name || !email || !phone || !vehicleId || !message) {
        return res.status(400).json({ error: 'Eksik bilgi' });
    }

    db.run(
        `INSERT INTO quotations (name, email, phone, vehicleId, message, status)
         VALUES (?, ?, ?, ?, ?, ?)`,
        [name, email, phone, vehicleId, message, status || 'yeni'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id: this.lastID, name, email, phone, vehicleId, message, status: status || 'yeni' });
        }
    );
});

// PUT teklif durumunu g√ºncelle (KORUNMALI)
app.put('/api/quotations/:id', authenticateToken, (req, res) => {
    const { status } = req.body;

    if (!status) {
        return res.status(400).json({ error: 'Durum gerekli' });
    }

    db.run(
        "UPDATE quotations SET status = ? WHERE id = ?",
        [status, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Teklif bulunamadƒ±' });
            }
            res.json({ id: req.params.id, status });
        }
    );
});

// DELETE teklifi sil (KORUNMALI)
app.delete('/api/quotations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM quotations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Teklif bulunamadƒ±' });
        }
        res.json({ message: 'Teklif silindi' });
    });
});

// ==========================================
// RESERVATIONS (ARA√á RESERVASYONLARƒ±) API
// ==========================================

// GET t√ºm rezervasyonlarƒ± al
app.get('/api/reservations', (req, res) => {
    db.all(`
        SELECT r.*, v.model as vehicleName, v.price as vehiclePrice
        FROM reservations r 
        LEFT JOIN vehicles v ON r.vehicleId = v.id 
        ORDER BY r.createdAt DESC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// POST yeni rezervasyon ekle
app.post('/api/reservations', (req, res) => {
    const { fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId, specialRequests, totalPrice } = req.body;

    // Validasyon
    if (!fullName || !email || !phone || !pickupLocation || !dropoffLocation || !pickupDate || !pickupTime || !dropoffDate || !dropoffTime) {
        return res.status(400).json({ error: 'Eksik bilgi' });
    }

    db.run(
        `INSERT INTO reservations (fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId, specialRequests, totalPrice, status)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId || null, specialRequests || null, totalPrice || null, 'yeni'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ 
                id: this.lastID, 
                fullName, email, phone, pickupLocation, dropoffLocation, 
                pickupDate, pickupTime, dropoffDate, dropoffTime, 
                vehicleId, specialRequests, totalPrice, status: 'yeni' 
            });
        }
    );
});

// PUT rezervasyon durumunu g√ºncelle (KORUNMALI)
app.put('/api/reservations/:id', authenticateToken, (req, res) => {
    const { status, totalPrice } = req.body;

    if (!status) {
        return res.status(400).json({ error: 'Durum gerekli' });
    }

    db.run(
        "UPDATE reservations SET status = ?, totalPrice = ? WHERE id = ?",
        [status, totalPrice || null, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Rezervasyon bulunamadƒ±' });
            }
            res.json({ id: req.params.id, status, totalPrice });
        }
    );
});

// DELETE rezervasyonu sil (KORUNMALI)
app.delete('/api/reservations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM reservations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Rezervasyon bulunamadƒ±' });
        }
        res.json({ message: 'Rezervasyon silindi' });
    });
});

// ==========================================
// LOCATIONS (ALI≈û/ƒ∞ADE YERLERƒ∞) API
// ==========================================

// GET t√ºm lokasyonlarƒ± al
app.get('/api/locations', (req, res) => {
    db.all(`
        SELECT * FROM locations 
        WHERE isActive = 1
        ORDER BY region ASC, name ASC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// GET t√ºm lokasyonlarƒ± (admin - deaktif dahil)
app.get('/api/locations/admin/all', (req, res) => {
    db.all(`
        SELECT * FROM locations 
        ORDER BY region ASC, name ASC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// GET lokasyonlarƒ± b√∂lgeye g√∂re grupla
app.get('/api/locations/grouped', (req, res) => {
    db.all(`
        SELECT DISTINCT region FROM locations 
        WHERE isActive = 1
        ORDER BY region ASC
    `, (err, regions) => {
        if (err) return res.status(500).json({ error: err.message });
        
        if (!regions) {
            return res.json({});
        }

        const grouped = {};
        let completed = 0;

        regions.forEach(r => {
            db.all(`
                SELECT * FROM locations 
                WHERE region = ? AND isActive = 1
                ORDER BY name ASC
            `, [r.region], (err, items) => {
                if (!err) {
                    grouped[r.region] = items;
                }
                completed++;
                if (completed === regions.length) {
                    res.json(grouped);
                }
            });
        });
    });
});

// POST yeni lokasyon ekle (KORUNMALI)
app.post('/api/locations', authenticateToken, [
    body('region').trim().notEmpty().escape(),
    body('name').trim().notEmpty().escape(),
    body('code').trim().notEmpty().escape()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    
    const { region, name, code, type } = req.body;

    db.run(
        "INSERT INTO locations (region, name, code, type) VALUES (?, ?, ?, ?)",
        [region, name, code, type || 'airport'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id: this.lastID, region, name, code, type: type || 'airport', isActive: 1 });
        }
    );
});

// PUT lokasyon g√ºncelle (KORUNMALI)
app.put('/api/locations/:id', authenticateToken, [
    body('region').trim().notEmpty().escape(),
    body('name').trim().notEmpty().escape(),
    body('code').trim().notEmpty().escape()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { region, name, code, type, isActive } = req.body;

    db.run(
        "UPDATE locations SET region = ?, name = ?, code = ?, type = ?, isActive = ? WHERE id = ?",
        [region, name, code, type || 'airport', isActive !== undefined ? isActive : 1, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Lokasyon bulunamadƒ±' });
            }
            res.json({ id: req.params.id, region, name, code, type, isActive });
        }
    );
});

// DELETE lokasyonu sil (KORUNMALI)
app.delete('/api/locations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM locations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Lokasyon bulunamadƒ±' });
        }
        res.json({ message: 'Lokasyon silindi' });
    });
});

// Admin panel route
app.get('/admin.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'admin.html'));
});

// Clear storage route
app.get('/clear-storage.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'clear-storage.html'));
});

// Import vehicles route
app.get('/import-vehicles.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'import-vehicles.html'));
});

// Image download endpoint (KORUNMALI - sadece admin)
app.post('/api/download-image', authenticateToken, async (req, res) => {
    const { imageUrl, vehicleName } = req.body;
    
    if (!imageUrl) {
        return res.status(400).json({ error: 'Image URL gerekli' });
    }

    try {
        // Dosya adƒ±nƒ± olu≈ütur (g√ºvenli hale getir)
        const timestamp = Date.now();
        const safeName = vehicleName 
            ? vehicleName.replace(/[^a-z0-9]/gi, '_').toLowerCase() 
            : 'vehicle';
        const fileName = `${safeName}_${timestamp}.webp`;
        const imgDir = path.join(__dirname, 'img');
        const filePath = path.join(imgDir, fileName);

        // img klas√∂r√º yoksa olu≈ütur
        if (!fs.existsSync(imgDir)) {
            fs.mkdirSync(imgDir, { recursive: true });
        }

        // URL'den resmi indir
        const file = fs.createWriteStream(filePath);
        
        https.get(imageUrl, (response) => {
            if (response.statusCode !== 200) {
                fs.unlinkSync(filePath);
                return res.status(400).json({ error: 'Resim indirilemedi' });
            }

            response.pipe(file);

            file.on('finish', () => {
                file.close();
                console.log(`‚úÖ Resim indirildi: ${fileName}`);
                res.json({ 
                    success: true, 
                    localPath: `/img/${fileName}`,
                    fileName: fileName 
                });
            });
        }).on('error', (err) => {
            fs.unlinkSync(filePath);
            console.error('‚ùå Download error:', err);
            res.status(500).json({ error: 'Resim indirilemedi' });
        });

    } catch (error) {
        console.error('‚ùå Image download error:', error);
        res.status(500).json({ error: error.message });
    }
});

// Server ba≈ülat
const server = app.listen(PORT, '0.0.0.0', () => {
    console.log(`\n‚úÖ EXPRESS HAZIR! Port: ${PORT}`);
    console.log(`üöÄ Sunucu URL: http://localhost:${PORT}\n`);
});

server.on('error', (err) => {
    console.error('‚ùå SERVER ERROR:', err);
    process.exit(1);
});

// Uncaught error handler
process.on('uncaughtException', (err) => {
    console.error('‚ùå UNCAUGHT EXCEPTION:', err);
    process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå UNHANDLED REJECTION:', reason);
});
