require('dotenv').config();
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const bodyParser = require('body-parser');
const cors = require('cors');
const path = require('path');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcryptjs');
const rateLimit = require('express-rate-limit');
const { body, validationResult } = require('express-validator');
const helmet = require('helmet');
const fs = require('fs');
const https = require('https');
const archiver = require('archiver');
const multer = require('multer');
const AdmZip = require('adm-zip');

const app = express();
app.set('trust proxy', 1);
const PORT = 3000;

// ===== G√úVENLƒ∞K AYARLARI =====

// JWT Secret Key (Production'da environment variable ZORUNLU!)
if (!process.env.JWT_SECRET) {
    console.error('‚ùå HATA: JWT_SECRET environment variable tanƒ±mlanmamƒ±≈ü!');
    console.error('L√ºtfen .env dosyasƒ±nda JWT_SECRET tanƒ±mlayƒ±n.');
    process.exit(1);
}
const JWT_SECRET = process.env.JWT_SECRET;
const JWT_EXPIRES_IN = '24h';

// Helmet - HTTP header g√ºvenliƒüi
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net", "https://cdn.tailwindcss.com"],
            scriptSrcAttr: ["'unsafe-inline'"], // onclick, onchange gibi inline event'ler i√ßin
            styleSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net", "https://cdn.tailwindcss.com"],
            imgSrc: ["'self'", "data:", "https:"],
            connectSrc: ["'self'"],
            fontSrc: ["'self'", "https://cdn.jsdelivr.net"],
            objectSrc: ["'none'"],
            mediaSrc: ["'self'"],
            frameSrc: ["'none'"]
        }
    },
    crossOriginEmbedderPolicy: false
}));

// CORS Konfig√ºrasyonu - Sadece kendi domain'e izin ver
const allowedOrigins = [
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'http://localhost:5173', // Vite dev server
    'http://127.0.0.1:5173',
    // Production domain'inizi buraya ekleyin: 'https://yourdomain.com'
];

const corsOptions = {
    origin: function (origin, callback) {
        const allowedOrigins = [
            'https://kiralikcar.com',
            'https://www.kiralikcar.com',
            'http://localhost:3000',
            'http://localhost:5173'
        ];
        // Sadece allowedOrigins i√ßindeki origin'lere izin ver
        if (allowedOrigins.includes(origin)) {
            callback(null, true);
        } else if (!origin) {
            // Same-origin isteklere (origin undefined) izin ver
            callback(null, true);
        } else {
            callback(new Error('CORS policy: Origin not allowed'));
        }    },
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    credentials: true
};

// Rate Limiting - DDoS korumasƒ±
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 dakika
    max: 30, // IP ba≈üƒ±na 30 istek (sƒ±kƒ±la≈ütƒ±rƒ±ldƒ±)
    message: '√áok fazla istek g√∂nderdiniz. L√ºtfen 15 dakika sonra tekrar deneyin.',
    standardHeaders: true,
    legacyHeaders: false,
    skip: (req) => {
        // Whitelist IP'ler - rate limit uygulanmaz
        const whitelist = ['176.4.5.13', '127.0.0.1', '::1'];
        const clientIp = req.ip || req.connection.remoteAddress;
        return whitelist.includes(clientIp);
    }
});

const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 dakika
    max: 5, // IP ba≈üƒ±na 5 login denemesi (sƒ±kƒ±la≈ütƒ±rƒ±ldƒ±)
    message: '√áok fazla giri≈ü denemesi. L√ºtfen 15 dakika sonra tekrar deneyin.',
    skipSuccessfulRequests: true, // Ba≈üarƒ±lƒ± giri≈ü sayƒ±lmaz
    standardHeaders: true,
    legacyHeaders: false,
    skip: (req) => {
        // Whitelist IP'ler - login limit uygulanmaz
        const whitelist = ['176.4.5.13', '127.0.0.1', '::1'];
        const clientIp = req.ip || req.connection.remoteAddress;
        return whitelist.includes(clientIp);
    }
});

// Middleware
app.use(cors(corsOptions));
app.use(limiter); // T√ºm route'lara rate limit uygula
app.use(bodyParser.json());

// G√úVENLƒ∞K: Hassas dosyalara eri≈üimi engelle
app.use((req, res, next) => {
    const blockedPaths = ['.db', '.env', '.git', 'node_modules', 'backups', 'package.json', 'server.cjs'];
    if (blockedPaths.some(blocked => req.path.includes(blocked))) {
        return res.status(403).json({ error: 'Eri≈üim engellendi' });
    }
    next();
});

app.use(express.static(path.join(__dirname, 'dist')));
// Admin panel i√ßin src klas√∂r√ºn√º de servis et
app.use('/src', express.static(path.join(__dirname, 'src')));
// img klas√∂r√ºn√º serve et
app.use('/img', express.static(path.join(__dirname, 'img')));

// SQLite Database
const db = new sqlite3.Database('./data.db', (err) => {
    if (err) console.error(err);
    else console.log('‚úì SQLite baƒülantƒ±sƒ± ba≈üarƒ±lƒ±');
});

// Tablolarƒ± olu≈ütur
db.serialize(() => {
    // Admin Users tablosu
    db.run(`CREATE TABLE IF NOT EXISTS admin_users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL,
        email TEXT,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        lastLogin DATETIME
    )`);

    // Vehicles tablosu
    db.run(`CREATE TABLE IF NOT EXISTS vehicles (
        id TEXT PRIMARY KEY,
        model TEXT NOT NULL,
        price TEXT NOT NULL,
        deposit TEXT NOT NULL,
        status TEXT NOT NULL,
        image TEXT NOT NULL
    )`);

    // Quotations (Teklifler) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS quotations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT NOT NULL,
        phone TEXT NOT NULL,
        vehicleId TEXT NOT NULL,
        message TEXT NOT NULL,
        status TEXT DEFAULT 'yeni',
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(vehicleId) REFERENCES vehicles(id)
    )`);

    // Reservations (Ara√ß Rezervasyonlarƒ±) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS reservations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        fullName TEXT NOT NULL,
        email TEXT NOT NULL,
        phone TEXT NOT NULL,
        pickupLocation TEXT NOT NULL,
        dropoffLocation TEXT NOT NULL,
        pickupDate TEXT NOT NULL,
        pickupTime TEXT NOT NULL,
        dropoffDate TEXT NOT NULL,
        dropoffTime TEXT NOT NULL,
        vehicleId TEXT,
        differentDropoff INTEGER DEFAULT 0,
        specialRequests TEXT,
        status TEXT DEFAULT 'yeni',
        totalPrice TEXT,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(vehicleId) REFERENCES vehicles(id)
    )`);

    // Locations (Alƒ±≈ü/ƒ∞ade Yerleri) tablosu
    db.run(`CREATE TABLE IF NOT EXISTS locations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        region TEXT NOT NULL UNIQUE,
        name TEXT NOT NULL,
        code TEXT NOT NULL,
        type TEXT NOT NULL DEFAULT 'airport',
        isActive INTEGER DEFAULT 1,
        createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);
});

// G√úVENLƒ∞K: Default admin kullanƒ±cƒ±sƒ± otomatik olu≈üturulmaz!
// ƒ∞lk kurulum i√ßin POST /api/auth/setup endpoint'ini kullanƒ±n
setTimeout(() => {
    db.get("SELECT COUNT(*) as count FROM admin_users", async (err, row) => {
        if (err) {
            console.error('‚ùå Admin user check hatasƒ±:', err);
            return;
        }
        
        if (row && row.count === 0) {
            console.log('‚ö†Ô∏è  UYARI: Hi√ß admin kullanƒ±cƒ±sƒ± yok!');
            console.log('üìù ƒ∞lk admin kullanƒ±cƒ±sƒ±nƒ± olu≈üturmak i√ßin:');
            console.log('   POST /api/auth/setup');
            console.log('   Body: { "username": "admin", "password": "g√º√ßl√º-≈üifre", "email": "email@domain.com" }');
            console.log('   ≈ûifre en az 8 karakter, b√ºy√ºk/k√º√ß√ºk harf, rakam ve √∂zel karakter i√ßermelidir.');
        }
    });
}, 200);

// Default ara√ßlarƒ± ekle
setTimeout(() => {
    db.get("SELECT COUNT(*) as count FROM vehicles", (err, row) => {
        if (err) {
            console.error('‚ùå SELECT COUNT hatasƒ±:', err);
            return;
        }
        console.log('üìä Ara√ß sayƒ±sƒ±:', row?.count);
        if (row && row.count === 0) {
            console.log('üöó Default ara√ßlar ekleniyor...');
            const defaultVehicles = [
                { id: '1', model: 'Toyota Corolla', price: '‚Ç∫450', deposit: '‚Ç∫5.000', status: 'M√ºsait', image: '/img/1.jpg' },
                { id: '2', model: 'Honda Civic', price: '‚Ç∫500', deposit: '‚Ç∫5.500', status: 'M√ºsait', image: '/img/2.jpg' },
                { id: '3', model: 'Ford Focus', price: '‚Ç∫480', deposit: '‚Ç∫5.200', status: 'M√ºsait', image: '/img/3.jpg' },
                { id: '4', model: 'Hyundai Elantra', price: '‚Ç∫420', deposit: '‚Ç∫4.800', status: 'M√ºsait', image: '/img/4.jpg' },
                { id: '5', model: 'Nissan Altima', price: '‚Ç∫520', deposit: '‚Ç∫5.800', status: 'M√ºsait', image: '/img/5.jpeg' }
            ];

            let inserted = 0;
            defaultVehicles.forEach(v => {
                db.run(
                    "INSERT INTO vehicles (id, model, price, deposit, status, image) VALUES (?, ?, ?, ?, ?, ?)",
                    [v.id, v.model, v.price, v.deposit, v.status, v.image],
                    (err) => {
                        if (err) console.error('‚ùå INSERT hatasƒ±:', err);
                        else inserted++;
                        if (inserted === defaultVehicles.length) {
                            console.log('‚úì T√ºm default ara√ßlar eklendi');
                        }
                    }
                );
            });
        }
    });

    // Default lokasyonlarƒ± ekle
    db.get("SELECT COUNT(*) as count FROM locations", (err, row) => {
        if (err) {
            console.error('‚ùå SELECT COUNT locations hatasƒ±:', err);
            return;
        }
        if (row && row.count === 0) {
            console.log('üìç Default lokasyonlar ekleniyor...');
            const defaultLocations = [
                { region: 'ƒ∞stanbul Avrupa', name: 'ƒ∞stanbul Havalimanƒ± (IST)', code: 'IST', type: 'airport' },
                { region: 'ƒ∞stanbul Anadolu', name: 'Sabiha G√∂k√ßen ƒ∞√ß Hatlar (SAW)', code: 'SAW', type: 'airport' },
                { region: 'ƒ∞stanbul Anadolu', name: 'Sabiha G√∂k√ßen Dƒ±≈ü Hatlar (SAW)', code: 'SAW', type: 'airport' },
                { region: 'ƒ∞zmir', name: 'Adnan Menderes H. Dƒ±≈ü Hatlar (ADB)', code: 'ADB', type: 'airport' },
                { region: 'ƒ∞zmir', name: 'Adnan Menderes H. ƒ∞√ß Hatlar (ADB)', code: 'ADB', type: 'airport' },
                { region: 'Antalya', name: 'Antalya Havalimanƒ± Dƒ±≈ü Hatlar (AYT)', code: 'AYT', type: 'airport' },
                { region: 'Antalya', name: 'Antalya Havalimanƒ± ƒ∞√ß Hatlar (AYT)', code: 'AYT', type: 'airport' },
                { region: 'Ankara', name: 'Esenboƒüa Havalimanƒ± Dƒ±≈ü Hatlar (ESB)', code: 'ESB', type: 'airport' },
                { region: 'Ankara', name: 'Esenboƒüa Havalimanƒ± ƒ∞√ß Hatlar (ESB)', code: 'ESB', type: 'airport' },
                { region: 'Kayseri', name: 'Kayseri Havalimanƒ± (ASR)', code: 'ASR', type: 'airport' },
                { region: 'Adana-Mersin', name: '√áukurova Havalimanƒ± (COV)', code: 'COV', type: 'airport' },
                { region: 'Gaziantep', name: 'Gaziantep Havalimanƒ± Dƒ±≈ü Hatlar (GZT)', code: 'GZT', type: 'airport' },
                { region: 'Gaziantep', name: 'Gaziantep Havalimanƒ± ƒ∞√ß Hatlar (GZT)', code: 'GZT', type: 'airport' },
                { region: 'Diyarbakƒ±r', name: 'Diyarbakƒ±r Havalimanƒ± (DIY)', code: 'DIY', type: 'airport' },
                { region: 'Diyarbakƒ±r', name: 'Diyarbakƒ±r Rancar Ofis (DIY)', code: 'DIY', type: 'office' },
                { region: 'Konya', name: 'Konya Havalimanƒ± Dƒ±≈ü Hatlar (KYA)', code: 'KYA', type: 'airport' },
                { region: 'Konya', name: 'Konya Havalimanƒ± ƒ∞√ß Hatlar (KYA)', code: 'KYA', type: 'airport' },
                { region: 'Trabzon', name: 'Trabzon Havalimanƒ± Dƒ±≈ü Hatlar (TZX)', code: 'TZX', type: 'airport' },
                { region: 'Trabzon', name: 'Trabzon Havalimanƒ± ƒ∞√ß Hatlar (TZX)', code: 'TZX', type: 'airport' },
                { region: 'Samsun', name: 'Samsun Havalimanƒ± (SZF)', code: 'SZF', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Havalimanƒ± ƒ∞√ß Hatlar (HTY)', code: 'HTY', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Havalimanƒ± Dƒ±≈ü Hatlar (HTY)', code: 'HTY', type: 'airport' },
                { region: 'Hatay', name: 'Hatay Rancar Ofis (HTY)', code: 'HTY', type: 'office' },
                { region: 'Dalaman', name: 'Dalaman Havalimanƒ± Dƒ±≈ü Hatlar (DLM)', code: 'DLM', type: 'airport' },
                { region: 'Dalaman', name: 'Dalaman Havalimanƒ± ƒ∞√ß Hatlar (DLM)', code: 'DLM', type: 'airport' },
                { region: 'Bodrum', name: 'Bodrum Havalimanƒ± Dƒ±≈ü Hatlar (BJV)', code: 'BJV', type: 'airport' },
                { region: 'Bodrum', name: 'Bodrum Havalimanƒ± ƒ∞√ß Hatlar (BJV)', code: 'BJV', type: 'airport' }
            ];

            let inserted = 0;
            defaultLocations.forEach(loc => {
                db.run(
                    "INSERT OR IGNORE INTO locations (region, name, code, type) VALUES (?, ?, ?, ?)",
                    [loc.region, loc.name, loc.code, loc.type],
                    (err) => {
                        if (err) console.error('‚ùå Location INSERT hatasƒ±:', err);
                        else inserted++;
                        if (inserted === defaultLocations.length) {
                            console.log(`‚úì ${defaultLocations.length} lokasyon eklendi`);
                        }
                    }
                );
            });
        }
    });
}, 300);

// ===== JWT MIDDLEWARE =====

// JWT Token doƒürulama middleware
function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

    if (!token) {
        return res.status(401).json({ error: 'Token bulunamadƒ±. Giri≈ü yapmanƒ±z gerekiyor.' });
    }

    jwt.verify(token, JWT_SECRET, (err, user) => {
        if (err) {
            console.error('‚ùå Token doƒürulama hatasƒ±:', err.message);
            return res.status(403).json({ error: 'Ge√ßersiz veya s√ºresi dolmu≈ü token.' });
        }
        req.user = user;
        next();
    });
}

// ===== AUTHENTICATION API =====

// POST ƒ∞lk Kurulum - Admin Olu≈ütur (sadece admin yoksa)
app.post('/api/auth/setup', [
    body('username').trim().isLength({ min: 4, max: 50 }).matches(/^[a-zA-Z0-9_]+$/).withMessage('Kullanƒ±cƒ± adƒ± sadece harf, rakam ve _ i√ßerebilir'),
    body('password').isLength({ min: 8 }).matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]/).withMessage('≈ûifre en az 8 karakter, b√ºy√ºk/k√º√ß√ºk harf, rakam ve √∂zel karakter i√ßermelidir'),
    body('email').trim().isEmail().normalizeEmail()
], async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    try {
        // Zaten admin var mƒ± kontrol et
        db.get("SELECT COUNT(*) as count FROM admin_users", async (err, row) => {
            if (err) {
                return res.status(500).json({ error: 'Veritabanƒ± hatasƒ±' });
            }
            
            if (row && row.count > 0) {
                return res.status(403).json({ error: 'Admin kullanƒ±cƒ±sƒ± zaten mevcut. Bu endpoint sadece ilk kurulum i√ßin kullanƒ±labilir.' });
            }

            const { username, password, email } = req.body;
            const hashedPassword = await bcrypt.hash(password, 12);
            
            db.run(
                "INSERT INTO admin_users (username, password, email) VALUES (?, ?, ?)",
                [username, hashedPassword, email],
                (err) => {
                    if (err) {
                        return res.status(500).json({ error: 'Admin kullanƒ±cƒ±sƒ± olu≈üturulamadƒ±' });
                    }
                    console.log(`‚úÖ ƒ∞lk admin kullanƒ±cƒ±sƒ± olu≈üturuldu: ${username}`);
                    res.json({ success: true, message: 'Admin kullanƒ±cƒ±sƒ± ba≈üarƒ±yla olu≈üturuldu. Artƒ±k giri≈ü yapabilirsiniz.' });
                }
            );
        });
    } catch (error) {
        console.error('‚ùå Setup hatasƒ±:', error);
        res.status(500).json({ error: 'Sunucu hatasƒ±' });
    }
});

// POST Admin Login
app.post('/api/auth/login', loginLimiter, [
    body('username').trim().isLength({ min: 3 }).escape(),
    body('password').isLength({ min: 6 })
], async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { username, password } = req.body;

    try {
        db.get("SELECT * FROM admin_users WHERE username = ?", [username], async (err, user) => {
            if (err) {
                console.error('‚ùå Login DB hatasƒ±:', err);
                return res.status(500).json({ error: 'Sunucu hatasƒ±' });
            }

            if (!user) {
                return res.status(401).json({ error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' });
            }

            const validPassword = await bcrypt.compare(password, user.password);
            if (!validPassword) {
                return res.status(401).json({ error: 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±' });
            }

            // JWT Token olu≈ütur
            const token = jwt.sign(
                { id: user.id, username: user.username },
                JWT_SECRET,
                { expiresIn: JWT_EXPIRES_IN }
            );

            // Son giri≈ü zamanƒ±nƒ± g√ºncelle
            db.run("UPDATE admin_users SET lastLogin = CURRENT_TIMESTAMP WHERE id = ?", [user.id]);

            console.log(`‚úÖ Admin giri≈üi: ${username}`);
            res.json({
                success: true,
                token,
                user: {
                    id: user.id,
                    username: user.username,
                    email: user.email
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Login hatasƒ±:', error);
        res.status(500).json({ error: 'Sunucu hatasƒ±' });
    }
});

// POST Token doƒürulama
app.post('/api/auth/verify', authenticateToken, (req, res) => {
    res.json({ success: true, user: req.user });
});

// POST ≈ûifre deƒüi≈ütirme
app.post('/api/auth/change-password', authenticateToken, [
    body('oldPassword').isLength({ min: 6 }),
    body('newPassword').isLength({ min: 6 })
], async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }

    const { oldPassword, newPassword } = req.body;

    try {
        db.get("SELECT * FROM admin_users WHERE id = ?", [req.user.id], async (err, user) => {
            if (err || !user) {
                return res.status(500).json({ error: 'Kullanƒ±cƒ± bulunamadƒ±' });
            }

            const validPassword = await bcrypt.compare(oldPassword, user.password);
            if (!validPassword) {
                return res.status(401).json({ error: 'Mevcut ≈üifre hatalƒ±' });
            }

            const hashedPassword = await bcrypt.hash(newPassword, 10);
            db.run("UPDATE admin_users SET password = ? WHERE id = ?", [hashedPassword, user.id], (err) => {
                if (err) {
                    return res.status(500).json({ error: '≈ûifre g√ºncellenemedi' });
                }
                console.log(`‚úÖ ≈ûifre deƒüi≈ütirildi: ${user.username}`);
                res.json({ success: true, message: '≈ûifre ba≈üarƒ±yla deƒüi≈ütirildi' });
            });
        });
    } catch (error) {
        console.error('‚ùå ≈ûifre deƒüi≈ütirme hatasƒ±:', error);
        res.status(500).json({ error: 'Sunucu hatasƒ±' });
    }
});

// ===== VEHICLES API =====

// GET t√ºm ara√ßlar
app.get('/api/vehicles', (req, res) => {
    console.log('üì° GET /api/vehicles isteƒüi alƒ±ndƒ±');
    db.all("SELECT * FROM vehicles", (err, rows) => {
        if (err) {
            console.error('‚ùå DB Hatasƒ±:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log(`‚úì ${rows?.length || 0} ara√ß d√∂nd√ºr√ºl√ºyor`);
        if (rows && rows.length > 0) {
            console.log('üîç ƒ∞lk ara√ß ID:', rows[0].id, 'Type:', typeof rows[0].id);
        }
        res.json(rows || []);
    });
});

// GET bir ara√ß (ID'ye g√∂re)
app.get('/api/vehicles/:id', (req, res) => {
    db.get("SELECT * FROM vehicles WHERE id = ?", [req.params.id], (err, row) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        if (!row) {
            return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
        }
        res.json(row);
    });
});

// POST yeni ara√ß ekle (KORUNMALI)
app.post('/api/vehicles', authenticateToken, [
    body('model').trim().notEmpty().escape(),
    body('price').trim().notEmpty(),
    body('deposit').trim().notEmpty()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { id, model, price, deposit, status, image } = req.body;

    if (!id || !model || !price || !deposit) {
        return res.status(400).json({ error: 'Gerekli alanlar eksik' });
    }

    db.run(
        "INSERT INTO vehicles (id, model, price, deposit, status, image) VALUES (?, ?, ?, ?, ?, ?)",
        [id, model, price, deposit, status || 'M√ºsait', image || '/img/default.png'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id, model, price, deposit, status: status || 'M√ºsait', image });
        }
    );
});

// PUT ara√ß g√ºncelle (KORUNMALI)
app.put('/api/vehicles/:id', authenticateToken, [
    body('model').trim().notEmpty().escape(),
    body('price').trim().notEmpty(),
    body('deposit').trim().notEmpty()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { model, price, deposit, status, image } = req.body;

    console.log('üîÑ UPDATE isteƒüi - ID:', req.params.id, 'Type:', typeof req.params.id);
    console.log('üìù Yeni veriler:', { model, price, deposit, status, image });

    db.run(
        "UPDATE vehicles SET model = ?, price = ?, deposit = ?, status = ?, image = ? WHERE id = ?",
        [model, price, deposit, status, image, req.params.id],
        function(err) {
            if (err) {
                console.error('‚ùå UPDATE hatasƒ±:', err);
                return res.status(500).json({ error: err.message });
            }
            console.log('‚úÖ UPDATE sonucu - Deƒüi≈ütirilen satƒ±r sayƒ±sƒ±:', this.changes);
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
            }
            res.json({ id: req.params.id, model, price, deposit, status, image });
        }
    );
});

// DELETE ara√ß sil (KORUNMALI)
app.delete('/api/vehicles/:id', authenticateToken, (req, res) => {
    console.log('üóëÔ∏è DELETE isteƒüi - ID:', req.params.id, 'Type:', typeof req.params.id);
    
    db.run("DELETE FROM vehicles WHERE id = ?", [req.params.id], function(err) {
        if (err) {
            console.error('‚ùå DELETE hatasƒ±:', err);
            return res.status(500).json({ error: err.message });
        }
        console.log('‚úÖ DELETE sonucu - Silinen satƒ±r sayƒ±sƒ±:', this.changes);
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Ara√ß bulunamadƒ±' });
        }
        res.json({ message: 'Ara√ß silindi' });
    });
});

// ==========================================
// QUOTATIONS (TKLƒ∞FLER) API ENDPOINTS
// ==========================================

// GET t√ºm teklifleri al
app.get('/api/quotations', (req, res) => {
    db.all(`
        SELECT q.*, v.model as vehicleName 
        FROM quotations q 
        LEFT JOIN vehicles v ON q.vehicleId = v.id 
        ORDER BY q.createdAt DESC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// POST yeni teklif ekle
app.post('/api/quotations', [
    body('name').trim().notEmpty().isLength({ max: 100 }).escape(),
    body('email').trim().isEmail().normalizeEmail(),
    body('phone').trim().matches(/^[0-9+\s()-]{10,20}$/),
    body('vehicleId').trim().notEmpty(),
    body('message').trim().notEmpty().isLength({ max: 1000 }).escape(),
    body('status').optional().trim().isIn(['yeni', 'g√∂r√ºld√º', 'yanƒ±tlandƒ±'])
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    
    const { name, email, phone, vehicleId, message, status } = req.body;

    db.run(
        `INSERT INTO quotations (name, email, phone, vehicleId, message, status)
         VALUES (?, ?, ?, ?, ?, ?)`,
        [name, email, phone, vehicleId, message, status || 'yeni'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id: this.lastID, name, email, phone, vehicleId, message, status: status || 'yeni' });
        }
    );
});

// PUT teklif durumunu g√ºncelle (KORUNMALI)
app.put('/api/quotations/:id', authenticateToken, (req, res) => {
    const { status } = req.body;

    if (!status) {
        return res.status(400).json({ error: 'Durum gerekli' });
    }

    db.run(
        "UPDATE quotations SET status = ? WHERE id = ?",
        [status, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Teklif bulunamadƒ±' });
            }
            res.json({ id: req.params.id, status });
        }
    );
});

// DELETE teklifi sil (KORUNMALI)
app.delete('/api/quotations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM quotations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Teklif bulunamadƒ±' });
        }
        res.json({ message: 'Teklif silindi' });
    });
});

// ==========================================
// RESERVATIONS (ARA√á RESERVASYONLARƒ±) API
// ==========================================

// GET t√ºm rezervasyonlarƒ± al
app.get('/api/reservations', (req, res) => {
    db.all(`
        SELECT r.*, v.model as vehicleName, v.price as vehiclePrice
        FROM reservations r 
        LEFT JOIN vehicles v ON r.vehicleId = v.id 
        ORDER BY r.createdAt DESC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// POST yeni rezervasyon ekle
app.post('/api/reservations', [
    body('fullName').trim().notEmpty().isLength({ max: 100 }).escape(),
    body('email').trim().isEmail().normalizeEmail(),
    body('phone').trim().matches(/^[0-9+\s()-]{10,20}$/),
    body('pickupLocation').trim().notEmpty().escape(),
    body('dropoffLocation').trim().notEmpty().escape(),
    body('pickupDate').trim().isISO8601().toDate(),
    body('pickupTime').trim().notEmpty(),
    body('dropoffDate').trim().isISO8601().toDate(),
    body('dropoffTime').trim().notEmpty(),
    body('vehicleId').optional().trim(),
    body('specialRequests').optional().trim().isLength({ max: 500 }).escape(),
    body('totalPrice').optional().trim()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    
    const { fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId, specialRequests, totalPrice } = req.body;

    db.run(
        `INSERT INTO reservations (fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId, specialRequests, totalPrice, status)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [fullName, email, phone, pickupLocation, dropoffLocation, pickupDate, pickupTime, dropoffDate, dropoffTime, vehicleId || null, specialRequests || null, totalPrice || null, 'yeni'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ 
                id: this.lastID, 
                fullName, email, phone, pickupLocation, dropoffLocation, 
                pickupDate, pickupTime, dropoffDate, dropoffTime, 
                vehicleId, specialRequests, totalPrice, status: 'yeni' 
            });
        }
    );
});

// PUT rezervasyon durumunu g√ºncelle (KORUNMALI)
app.put('/api/reservations/:id', authenticateToken, (req, res) => {
    const { status, totalPrice } = req.body;

    if (!status) {
        return res.status(400).json({ error: 'Durum gerekli' });
    }

    db.run(
        "UPDATE reservations SET status = ?, totalPrice = ? WHERE id = ?",
        [status, totalPrice || null, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Rezervasyon bulunamadƒ±' });
            }
            res.json({ id: req.params.id, status, totalPrice });
        }
    );
});

// DELETE rezervasyonu sil (KORUNMALI)
app.delete('/api/reservations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM reservations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Rezervasyon bulunamadƒ±' });
        }
        res.json({ message: 'Rezervasyon silindi' });
    });
});

// ==========================================
// LOCATIONS (ALI≈û/ƒ∞ADE YERLERƒ∞) API
// ==========================================

// GET t√ºm lokasyonlarƒ± al
app.get('/api/locations', (req, res) => {
    db.all(`
        SELECT * FROM locations 
        WHERE isActive = 1
        ORDER BY region ASC, name ASC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// GET t√ºm lokasyonlarƒ± (admin - deaktif dahil)
app.get('/api/locations/admin/all', (req, res) => {
    db.all(`
        SELECT * FROM locations 
        ORDER BY region ASC, name ASC
    `, (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows || []);
    });
});

// GET lokasyonlarƒ± b√∂lgeye g√∂re grupla
app.get('/api/locations/grouped', (req, res) => {
    db.all(`
        SELECT DISTINCT region FROM locations 
        WHERE isActive = 1
        ORDER BY region ASC
    `, (err, regions) => {
        if (err) return res.status(500).json({ error: err.message });
        
        if (!regions) {
            return res.json({});
        }

        const grouped = {};
        let completed = 0;

        regions.forEach(r => {
            db.all(`
                SELECT * FROM locations 
                WHERE region = ? AND isActive = 1
                ORDER BY name ASC
            `, [r.region], (err, items) => {
                if (!err) {
                    grouped[r.region] = items;
                }
                completed++;
                if (completed === regions.length) {
                    res.json(grouped);
                }
            });
        });
    });
});

// POST yeni lokasyon ekle (KORUNMALI)
app.post('/api/locations', authenticateToken, [
    body('region').trim().notEmpty().escape(),
    body('name').trim().notEmpty().escape(),
    body('code').trim().notEmpty().escape()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    
    const { region, name, code, type } = req.body;

    db.run(
        "INSERT INTO locations (region, name, code, type) VALUES (?, ?, ?, ?)",
        [region, name, code, type || 'airport'],
        function(err) {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json({ id: this.lastID, region, name, code, type: type || 'airport', isActive: 1 });
        }
    );
});

// PUT lokasyon g√ºncelle (KORUNMALI)
app.put('/api/locations/:id', authenticateToken, [
    body('region').trim().notEmpty().escape(),
    body('name').trim().notEmpty().escape(),
    body('code').trim().notEmpty().escape()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    const { region, name, code, type, isActive } = req.body;

    db.run(
        "UPDATE locations SET region = ?, name = ?, code = ?, type = ?, isActive = ? WHERE id = ?",
        [region, name, code, type || 'airport', isActive !== undefined ? isActive : 1, req.params.id],
        function(err) {
            if (err) return res.status(500).json({ error: err.message });
            if (this.changes === 0) {
                return res.status(404).json({ error: 'Lokasyon bulunamadƒ±' });
            }
            res.json({ id: req.params.id, region, name, code, type, isActive });
        }
    );
});

// DELETE lokasyonu sil (KORUNMALI)
app.delete('/api/locations/:id', authenticateToken, (req, res) => {
    db.run("DELETE FROM locations WHERE id = ?", [req.params.id], function(err) {
        if (err) return res.status(500).json({ error: err.message });
        if (this.changes === 0) {
            return res.status(404).json({ error: 'Lokasyon bulunamadƒ±' });
        }
        res.json({ message: 'Lokasyon silindi' });
    });
});

// Admin panel route
app.get('/admin.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'admin.html'));
});

// Clear storage route
app.get('/clear-storage.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'clear-storage.html'));
});

// Import vehicles route
app.get('/import-vehicles.html', (req, res) => {
    res.sendFile(path.join(__dirname, 'import-vehicles.html'));
});

// Image download endpoint (KORUNMALI - sadece admin)
app.post('/api/download-image', authenticateToken, async (req, res) => {
    const { imageUrl, vehicleName } = req.body;
    
    if (!imageUrl) {
        return res.status(400).json({ error: 'Image URL gerekli' });
    }

    try {
        // Dosya adƒ±nƒ± olu≈ütur (g√ºvenli hale getir)
        const timestamp = Date.now();
        const safeName = vehicleName 
            ? vehicleName.replace(/[^a-z0-9]/gi, '_').toLowerCase() 
            : 'vehicle';
        const fileName = `${safeName}_${timestamp}.webp`;
        const imgDir = path.join(__dirname, 'img');
        const filePath = path.join(imgDir, fileName);

        // img klas√∂r√º yoksa olu≈ütur
        if (!fs.existsSync(imgDir)) {
            fs.mkdirSync(imgDir, { recursive: true });
        }

        // URL'den resmi indir
        const file = fs.createWriteStream(filePath);
        
        https.get(imageUrl, (response) => {
            if (response.statusCode !== 200) {
                fs.unlinkSync(filePath);
                return res.status(400).json({ error: 'Resim indirilemedi' });
            }

            response.pipe(file);

            file.on('finish', () => {
                file.close();
                console.log(`‚úÖ Resim indirildi: ${fileName}`);
                res.json({ 
                    success: true, 
                    localPath: `/img/${fileName}`,
                    fileName: fileName 
                });
            });
        }).on('error', (err) => {
            fs.unlinkSync(filePath);
            console.error('‚ùå Download error:', err);
            res.status(500).json({ error: 'Resim indirilemedi' });
        });

    } catch (error) {
        console.error('‚ùå Image download error:', error);
        res.status(500).json({ error: error.message });
    }
});

// ===== BACKUP API =====

// Backups klas√∂r√ºn√º olu≈ütur
const backupsDir = path.join(__dirname, 'backups');
if (!fs.existsSync(backupsDir)) {
    fs.mkdirSync(backupsDir, { recursive: true });
}

// GET Yedekleme listesi
app.get('/api/backups', authenticateToken, (req, res) => {
    try {
        if (!fs.existsSync(backupsDir)) {
            return res.json([]);
        }

        const files = fs.readdirSync(backupsDir)
            .filter(file => file.endsWith('.zip'))
            .map(file => {
                const stats = fs.statSync(path.join(backupsDir, file));
                return {
                    name: file,
                    size: (stats.size / 1024 / 1024).toFixed(2) + ' MB',
                    sizeBytes: stats.size,
                    date: stats.mtime,
                    dateFormatted: new Date(stats.mtime).toLocaleString('tr-TR')
                };
            })
            .sort((a, b) => b.date - a.date); // Yeniden eskiye sƒ±rala

        res.json(files);
    } catch (error) {
        console.error('‚ùå Backup listesi hatasƒ±:', error);
        res.status(500).json({ error: error.message });
    }
});

// POST Yedekleme olu≈ütur
app.post('/api/backups/create', authenticateToken, async (req, res) => {
    try {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const backupFileName = `backup-${timestamp}.zip`;
        const backupPath = path.join(backupsDir, backupFileName);

        const output = fs.createWriteStream(backupPath);
        const archive = archiver('zip', {
            zlib: { level: 9 } // Maksimum sƒ±kƒ±≈ütƒ±rma
        });

        // Hata kontrol√º
        output.on('error', (err) => {
            console.error('‚ùå Output stream hatasƒ±:', err);
            res.status(500).json({ error: 'Yedekleme dosyasƒ± olu≈üturulamadƒ±' });
        });

        archive.on('error', (err) => {
            console.error('‚ùå Archive hatasƒ±:', err);
            res.status(500).json({ error: 'Yedekleme ar≈üivi olu≈üturulamadƒ±' });
        });

        archive.on('warning', (err) => {
            if (err.code === 'ENOENT') {
                console.warn('‚ö†Ô∏è Archive uyarƒ±sƒ±:', err);
            } else {
                throw err;
            }
        });

        // Yedekleme tamamlandƒ±ƒüƒ±nda
        output.on('close', () => {
            const sizeInMB = (archive.pointer() / 1024 / 1024).toFixed(2);
            console.log(`‚úÖ Yedekleme tamamlandƒ±: ${backupFileName} (${sizeInMB} MB)`);
            res.json({
                success: true,
                message: 'Yedekleme ba≈üarƒ±yla olu≈üturuldu',
                file: backupFileName,
                size: sizeInMB + ' MB'
            });
        });

        archive.pipe(output);

        // Veritabanƒ±nƒ± ekle
        if (fs.existsSync('./data.db')) {
            archive.file('./data.db', { name: 'data.db' });
        }

        // T√ºm proje dosyalarƒ±nƒ± ekle (node_modules ve backups hari√ß)
        const excludeDirs = ['node_modules', 'backups', '.git', 'dist'];
        
        // Kaynak dosyalarƒ± ekle
        if (fs.existsSync('./src')) {
            archive.directory('./src', 'src', (entry) => {
                return !excludeDirs.some(dir => entry.name.includes(dir));
            });
        }

        // Public dosyalarƒ±nƒ± ekle
        if (fs.existsSync('./public')) {
            archive.directory('./public', 'public');
        }

        // Resim klas√∂r√ºn√º ekle
        if (fs.existsSync('./img')) {
            archive.directory('./img', 'img');
        }

        // Konfig√ºrasyon dosyalarƒ±nƒ± ekle
        const configFiles = [
            'package.json',
            'server.cjs',
            'vite.config.js',
            'tailwind.config.js',
            'tsconfig.json',
            'eslint.config.js',
            'biome.json',
            'postcss.config.js',
            'netlify.toml',
            'index.html',
            'admin.html',
            'import-vehicles.html'
        ];

        configFiles.forEach(file => {
            if (fs.existsSync(file)) {
                archive.file(file, { name: file });
            }
        });

        // Ar≈üivi tamamla
        await archive.finalize();

    } catch (error) {
        console.error('‚ùå Backup olu≈üturma hatasƒ±:', error);
        res.status(500).json({ error: error.message });
    }
});

// GET Yedekleme indir
app.get('/api/backups/download/:filename', authenticateToken, (req, res) => {
    try {
        const filename = req.params.filename;
        
        // G√ºvenlik kontrol√º - path traversal saldƒ±rƒ±larƒ±nƒ± √∂nle
        if (!filename.endsWith('.zip') || filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
            return res.status(400).json({ error: 'Ge√ßersiz dosya adƒ±' });
        }
        
        const filePath = path.resolve(backupsDir, filename);
        
        // Path'in backupsDir i√ßinde olduƒüunu doƒürula
        if (!filePath.startsWith(path.resolve(backupsDir))) {
            return res.status(400).json({ error: 'Ge√ßersiz dosya yolu' });
        }

        if (!fs.existsSync(filePath)) {
            return res.status(404).json({ error: 'Yedekleme dosyasƒ± bulunamadƒ±' });
        }

        res.download(filePath, filename, (err) => {
            if (err) {
                console.error('‚ùå Download hatasƒ±:', err);
                res.status(500).json({ error: 'Dosya indirilemedi' });
            }
        });
    } catch (error) {
        console.error('‚ùå Backup download hatasƒ±:', error);
        res.status(500).json({ error: error.message });
    }
});

// DELETE Yedekleme sil
app.delete('/api/backups/:filename', authenticateToken, (req, res) => {
    try {
        const filename = req.params.filename;
        
        // G√ºvenlik kontrol√º
        if (!filename.endsWith('.zip') || filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
            return res.status(400).json({ error: 'Ge√ßersiz dosya adƒ±' });
        }
        
        const filePath = path.resolve(backupsDir, filename);
        
        // Path'in backupsDir i√ßinde olduƒüunu doƒürula
        if (!filePath.startsWith(path.resolve(backupsDir))) {
            return res.status(400).json({ error: 'Ge√ßersiz dosya yolu' });
        }

        if (!fs.existsSync(filePath)) {
            return res.status(404).json({ error: 'Yedekleme dosyasƒ± bulunamadƒ±' });
        }

        fs.unlinkSync(filePath);
        console.log(`‚úÖ Yedekleme silindi: ${filename}`);
        res.json({ success: true, message: 'Yedekleme ba≈üarƒ±yla silindi' });
    } catch (error) {
        console.error('‚ùå Backup silme hatasƒ±:', error);
        res.status(500).json({ error: error.message });
    }
});

// Multer konfig√ºrasyonu - dosya y√ºkleme i√ßin
const upload = multer({
    dest: path.join(backupsDir, 'temp'),
    limits: {
        fileSize: 100 * 1024 * 1024 // 100 MB max
    },
    fileFilter: (req, file, cb) => {
        if (file.originalname.endsWith('.zip')) {
            cb(null, true);
        } else {
            cb(new Error('Sadece .zip dosyalarƒ± desteklenir'));
        }
    }
});

// POST Yedek y√ºkleme (Restore)
app.post('/api/backups/restore', authenticateToken, upload.single('backup'), async (req, res) => {
    let tempFilePath = null;
    
    try {
        if (!req.file) {
            return res.status(400).json({ error: 'Dosya y√ºklenmedi' });
        }

        tempFilePath = req.file.path;
        console.log(`üì¶ Yedek dosyasƒ± y√ºklendi: ${req.file.originalname}`);

        // ZIP dosyasƒ±nƒ± a√ß
        const zip = new AdmZip(tempFilePath);
        const zipEntries = zip.getEntries();

        console.log('üìÇ ZIP i√ßeriƒüi kontrol ediliyor...');

        // Veritabanƒ±nƒ± geri y√ºkle
        const dbEntry = zipEntries.find(entry => entry.entryName === 'data.db');
        if (dbEntry) {
            // Mevcut veritabanƒ±nƒ± yedekle
            const dbBackupPath = './data.db.backup-' + Date.now();
            if (fs.existsSync('./data.db')) {
                fs.copyFileSync('./data.db', dbBackupPath);
                console.log(`üíæ Mevcut veritabanƒ± yedeklendi: ${dbBackupPath}`);
            }

            // Yeni veritabanƒ±nƒ± √ßƒ±kart
            zip.extractEntryTo(dbEntry, './', false, true);
            console.log('‚úÖ Veritabanƒ± geri y√ºklendi');
        }

        // Resimleri geri y√ºkle
        const imgDir = './img';
        if (!fs.existsSync(imgDir)) {
            fs.mkdirSync(imgDir, { recursive: true });
        }

        const imgEntries = zipEntries.filter(entry => 
            entry.entryName.startsWith('img/') && !entry.isDirectory
        );

        if (imgEntries.length > 0) {
            // Mevcut resimleri yedekle
            const imgBackupDir = './img-backup-' + Date.now();
            if (fs.existsSync(imgDir)) {
                fs.renameSync(imgDir, imgBackupDir);
                console.log(`üíæ Mevcut resimler yedeklendi: ${imgBackupDir}`);
                fs.mkdirSync(imgDir, { recursive: true });
            }

            // Yeni resimleri √ßƒ±kart
            imgEntries.forEach(entry => {
                const fileName = path.basename(entry.entryName);
                zip.extractEntryTo(entry, imgDir, false, true, false, fileName);
            });
            console.log(`‚úÖ ${imgEntries.length} resim geri y√ºklendi`);
        }

        // Kaynak dosyalarƒ± geri y√ºkle (isteƒüe baƒülƒ±)
        const srcDir = './src';
        const srcEntries = zipEntries.filter(entry => 
            entry.entryName.startsWith('src/') && !entry.isDirectory
        );

        if (srcEntries.length > 0) {
            // Mevcut src'yi yedekle
            const srcBackupDir = './src-backup-' + Date.now();
            if (fs.existsSync(srcDir)) {
                fs.renameSync(srcDir, srcBackupDir);
                console.log(`üíæ Mevcut kaynak dosyalarƒ± yedeklendi: ${srcBackupDir}`);
                fs.mkdirSync(srcDir, { recursive: true });
            }

            // Yeni kaynak dosyalarƒ±nƒ± √ßƒ±kart
            zip.extractAllTo('./', true);
            console.log(`‚úÖ Kaynak dosyalarƒ± geri y√ºklendi`);
        }

        // Temp dosyasƒ±nƒ± sil
        fs.unlinkSync(tempFilePath);

        console.log('üéâ Yedek ba≈üarƒ±yla geri y√ºklendi!');
        res.json({
            success: true,
            message: 'Yedek ba≈üarƒ±yla geri y√ºklendi',
            restored: {
                database: !!dbEntry,
                images: imgEntries.length,
                sourceFiles: srcEntries.length
            }
        });

    } catch (error) {
        console.error('‚ùå Restore hatasƒ±:', error);
        
        // Temp dosyasƒ±nƒ± temizle
        if (tempFilePath && fs.existsSync(tempFilePath)) {
            fs.unlinkSync(tempFilePath);
        }
        
        res.status(500).json({ error: error.message });
    }
});

// SPA Fallback - T√ºm diƒüer route'lardan sonra gelmeli
app.use((req, res) => {
    res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

// Server ba≈ülat
const server = app.listen(PORT, '127.0.0.1', () => {
    console.log(`\n‚úÖ EXPRESS HAZIR! Port: ${PORT}`);
    console.log(`üöÄ Sunucu URL: http://localhost:${PORT}\n`);
});

server.on('error', (err) => {
    console.error('‚ùå SERVER ERROR:', err);
    process.exit(1);
});

// Uncaught error handler
process.on('uncaughtException', (err) => {
    console.error('‚ùå UNCAUGHT EXCEPTION:', err);
    process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå UNHANDLED REJECTION:', reason);
});
